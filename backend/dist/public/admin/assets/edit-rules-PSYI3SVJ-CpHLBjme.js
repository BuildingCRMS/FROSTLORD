import{R as S}from"./chunk-GBFMXRDA-DCDH2tht.js";import{R as A,b as _,da as B,j as s,H as C,d5 as D,db as H,dc as U,dd as z,r as K,a8 as L,ab as M,B as P,a2 as v,ad as w,a4 as u,a3 as F,ae as N,af as T,ao as p}from"./index-C-aqpPpW.js";import"./chunk-2PMSBTXI-DuCuD73b.js";import{K as V}from"./chunk-6HTZNHPT-CgFEWPk_.js";import{b as m,u as $}from"./chunk-4TC5YS65-CUs0cNRB.js";import"./chunk-HFB3OQXI-CQDjKhMR.js";import"./x-mark-mini-BfhzaRzl.js";import"./select-BUeGlheq.js";import"./check-Dq7ON1mU.js";import"./triangles-mini-DMlStY_2.js";import"./plus-mini-DiXGmMQk.js";import"./prompt-Cl5xfF6Y.js";var k=v({type:u().optional(),rules:w(v({id:u().optional(),attribute:u().min(1,{message:p.t("promotions.form.required")}),operator:u().min(1,{message:p.t("promotions.form.required")}),values:N([T().min(1,{message:p.t("promotions.form.required")}),u().min(1,{message:p.t("promotions.form.required")}),w(u()).min(1,{message:p.t("promotions.form.required")})]),required:F().optional(),disguised:F().optional(),field_type:u().optional()}))}),I=({promotion:t,ruleType:f,handleSubmit:n,isSubmitting:r})=>{const{t:d}=_(),[o,a]=K.useState([]),l=L({defaultValues:{rules:[],type:t.type},resolver:M(k)}),c=l.handleSubmit(n(o));return s.jsx(m.Form,{form:l,children:s.jsxs(V,{onSubmit:c,className:"flex h-full flex-col",children:[s.jsx(m.Body,{children:s.jsx(S,{form:l,ruleType:f,setRulesToRemove:a,rulesToRemove:o,promotion:t})}),s.jsx(m.Footer,{children:s.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[s.jsx(m.Close,{asChild:!0,children:s.jsx(P,{size:"small",variant:"secondary",disabled:r,children:d("actions.cancel")})}),s.jsx(P,{size:"small",type:"submit",isLoading:r,children:d("actions.save")})]})})]})})},O=t=>t.field_type==="number"?parseInt(t.values):t.values,W=({promotion:t,rules:f,ruleType:n})=>{const{handleSuccess:r}=$(),{mutateAsync:d}=D(t.id),{mutateAsync:o}=H(t.id,n),{mutateAsync:a}=U(t.id,n),{mutateAsync:l,isPending:c}=z(t.id,n),y=i=>async function(h){const g={},{rules:b=[]}=h,E=b.filter(e=>e.disguised),q=(i==null?void 0:i.filter(e=>e.disguised))||[];for(const e of E)g[e.attribute]=O(e);for(const e of q)g[e.attribute]=null;const x=b.filter(e=>!e.disguised),j=x.filter(e=>!("id"in e)),R=x.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),j.length&&await o({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),i!=null&&i.length&&await a({rule_ids:i.map(e=>e.id).filter(Boolean)}),R.length&&await l({rules:R.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),r()};return s.jsx(I,{promotion:t,rules:f,ruleType:n,handleSubmit:y,isSubmitting:c})},oe=()=>{var i,h;const t=A();if(!["rules","buy-rules","target-rules"].includes(t.ruleType))throw"invalid page";const{t:n}=_(),r=t.ruleType,d=t.id,o=[],{promotion:a,isPending:l,isError:c,error:y}=B(d);if(a&&(r==="rules"?o.push(...a.rules||[]):r==="target-rules"?o.push(...((i=a==null?void 0:a.application_method)==null?void 0:i.target_rules)||[]):r==="buy-rules"&&o.push(...((h=a.application_method)==null?void 0:h.buy_rules)||[])),c)throw y;return s.jsxs(m,{children:[s.jsx(m.Header,{children:s.jsx(C,{children:n(`promotions.edit.${r}.title`)})}),!l&&a&&s.jsx(W,{promotion:a,rules:o,ruleType:r})]})};export{oe as Component};
